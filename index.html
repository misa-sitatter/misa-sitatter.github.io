<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MISA-SITATTER</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(to bottom, #ffe6f1, #ffd1e8);
    color: #333;
  }
  h1 {
    text-align: center;
    color: #ff5ca2;
  }
  #controls {
    padding: 10px;
    background: rgba(255, 240, 246, 0.9);
  }
  #characterList {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  .charCard {
    background: #fff0f6;
    border: 2px solid #ff9ec9;
    padding: 5px;
    border-radius: 10px;
    width: 150px;
  }
  .charCard input {
    width: 100%;
    margin-bottom: 5px;
  }
  canvas {
    display: block;
    margin: auto;
    background-color: transparent;
    touch-action: none;
  }
</style>
</head>
<body>
<h1>MISA-SITATTER</h1>
<div id="controls">
  <input type="file" id="imageUpload">
  <input type="text" id="nameInput" placeholder="Name">
  <input type="number" id="heightInput" placeholder="Height (cm)">
  <button id="addBtn">Add Character</button>
  <div id="characterList"></div>
</div>
<canvas id="chart"></canvas>
<script>
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');
let characters = [];
let tallestHeight = 0;
let draggingChar = null;
let offsetX = 0;
let offsetY = 0;

function resizeCanvas() {
  const ratio = window.devicePixelRatio || 1;
  canvas.width = window.innerWidth * ratio;
  canvas.height = (window.innerHeight - document.getElementById('controls').offsetHeight) * ratio;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = (window.innerHeight - document.getElementById('controls').offsetHeight) + 'px';
  ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  draw();
}

function drawGrid() {
  ctx.font = '12px Arial';
  ctx.fillStyle = '#ff5ca2';
  ctx.textAlign = 'right';
  ctx.strokeStyle = '#ffc1d9';
  ctx.lineWidth = 1;
  for (let cm = 0; cm <= tallestHeight + 20; cm += 5) {
    let y = canvas.height / (window.devicePixelRatio || 1) - cm * 3; // 3px per cm
    ctx.beginPath();
    ctx.moveTo(30, y);
    ctx.lineTo(canvas.width, y);
    ctx.strokeStyle = (cm % 10 === 0) ? '#ff8cb8' : '#ffd6e6';
    ctx.stroke();
    ctx.fillText(cm, 25, y + 3);
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawGrid();
  characters.forEach(char => {
    if (!char.img) return;
    const scale = char.height / char.img.naturalHeight;
    const displayHeight = char.height * 3; // px scale
    const displayWidth = char.img.naturalWidth * (displayHeight / char.img.naturalHeight);
    ctx.drawImage(char.img, char.x, canvas.height/(window.devicePixelRatio||1) - displayHeight, displayWidth, displayHeight);
    ctx.fillStyle = '#ff5ca2';
    ctx.textAlign = 'center';
    ctx.fillText(char.name, char.x + displayWidth / 2, canvas.height/(window.devicePixelRatio||1) - displayHeight - 5);
  });
}

function updateTallest() {
  tallestHeight = Math.max(...characters.map(c => c.height), 0);
}

function addCharacter(img, name, height) {
  const char = {
    img, name, height,
    x: characters.length * 100 + 50
  };
  characters.push(char);
  updateTallest();
  updateCharacterList();
  draw();
}

function updateCharacterList() {
  const list = document.getElementById('characterList');
  list.innerHTML = '';
  characters.forEach((char, index) => {
    const card = document.createElement('div');
    card.className = 'charCard';
    const nameInput = document.createElement('input');
    nameInput.value = char.name;
    nameInput.oninput = e => { char.name = e.target.value; draw(); };
    const heightInput = document.createElement('input');
    heightInput.type = 'number';
    heightInput.value = char.height;
    heightInput.oninput = e => { char.height = parseFloat(e.target.value) || 0; updateTallest(); draw(); };
    const imgInput = document.createElement('input');
    imgInput.type = 'file';
    imgInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const newImg = new Image();
      newImg.onload = () => { char.img = newImg; draw(); };
      newImg.src = URL.createObjectURL(file);
    };
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.onclick = () => { characters.splice(index, 1); updateTallest(); updateCharacterList(); draw(); };
    card.append(nameInput, heightInput, imgInput, delBtn);
    list.appendChild(card);
  });
}

let upload = document.getElementById('imageUpload');
document.getElementById('addBtn').onclick = () => {
  const name = document.getElementById('nameInput').value || 'Unnamed';
  const height = parseFloat(document.getElementById('heightInput').value) || 0;
  const file = upload.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => { addCharacter(img, name, height); };
  img.src = URL.createObjectURL(file);
};

canvas.addEventListener('mousedown', startDrag);
canvas.addEventListener('touchstart', startDrag);
canvas.addEventListener('mousemove', drag);
canvas.addEventListener('touchmove', drag);
canvas.addEventListener('mouseup', endDrag);
canvas.addEventListener('touchend', endDrag);

function getCharAtPos(x, y) {
  return characters.find(char => {
    const displayHeight = char.height * 3;
    const displayWidth = char.img.naturalWidth * (displayHeight / char.img.naturalHeight);
    return x >= char.x && x <= char.x + displayWidth &&
           y >= canvas.height/(window.devicePixelRatio||1) - displayHeight && y <= canvas.height/(window.devicePixelRatio||1);
  });
}

function startDrag(e) {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  const char = getCharAtPos(x, y);
  if (char) {
    draggingChar = char;
    offsetX = x - char.x;
  }
}

function drag(e) {
  if (!draggingChar) return;
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  draggingChar.x = x - offsetX;
  draw();
}

function endDrag() {
  draggingChar = null;
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();
</script>
</body>
</html>
